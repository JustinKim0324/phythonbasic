<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <base href="/phythonbasic/">
  <title>강의 보기</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; line-height: 1.6; margin: 24px; color:#222; }
    .container { max-width: 860px; margin: 0 auto; }
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    .topbar a { text-decoration:none; color:#2563eb; }
    .status { font-size:14px; color:#666; }
    img { max-width:100%; height:auto; }
    blockquote { border-left:4px solid #e5e7eb; margin: 0; padding: 0 12px; color:#555; }
    pre { overflow:auto; border-radius:10px; padding: 14px; }
    code, pre code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.95rem; }
    :not(pre) > code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }

    /* 에러 박스 */
    .error { background:#fff1f2; color:#b91c1c; border:1px solid #fecaca; padding:12px; border-radius:8px; margin-top:12px; white-space:pre-wrap; }
  </style>

  <!-- highlight.js (테마 + 공통 번들) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <!-- marked UMD (버전 고정) -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script>
  <!-- marked-highlight UMD (버전 고정) -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked-highlight@2.1.3/lib/index.umd.js"></script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a href="index.html">← 목록으로</a>
      <span class="status" id="status">강의 내용을 불러오는 중…</span>
    </div>
    <article id="content"></article>
    <div id="error" class="error" style="display:none;"></div>
  </div>

  <script>
    // 화면에 에러 표시
    function showError(e) {
      const box = document.getElementById('error');
      box.style.display = 'block';
      box.textContent = String(e && e.stack ? e.stack : e);
    }

    window.addEventListener('load', () => {
      (async function () {
        const statusEl  = document.getElementById('status');
        const contentEl = document.getElementById('content');

        try {
          const params   = new URLSearchParams(location.search);
          const rawFile  = params.get('file') || 'lessons1.md';
          const isSafe   = /^[a-zA-Z0-9._-]+\.md$/.test(rawFile);
          const file     = isSafe ? rawFile : 'lessons1.md';

          // 전역 체크 (CDN 로딩 실패 원인 파악)
          const hasMarked = !!(globalThis.marked && globalThis.marked.Marked);
          const hasHL     = !!(globalThis.hljs);
          const hasMH     = !!(globalThis.markedHighlight && globalThis.markedHighlight.markedHighlight);

          if (!hasMarked) throw new Error('marked UMD가 로드되지 않았습니다.');
          if (!hasHL)     throw new Error('highlight.js가 로드되지 않았습니다.');
          if (!hasMH)     throw new Error('marked-highlight가 로드되지 않았습니다.');

          const { Marked } = globalThis.marked;
          const { markedHighlight } = globalThis.markedHighlight;

          // marked + marked-highlight로 파서 생성
          const parser = new Marked(
            markedHighlight({
              emptyLangClass: 'hljs',
              langPrefix: 'hljs language-',
              highlight(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
              }
            })
          );
          parser.setOptions({ gfm: true });

          // md 불러오기 (상대경로 → /phythonbasic/<file>)
          const res = await fetch(file, { cache: 'no-store' });
          if (!res.ok) throw new Error(`MD 파일 로드 실패: ${file} (${res.status} ${res.statusText})`);
          const md = await res.text();

          // 파싱 & 렌더
          const html = parser.parse(md);
          contentEl.innerHTML = html;
          statusEl.textContent = file + ' 로딩 완료';

          // 혹시 동적 추가 대비
          document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        } catch (e) {
          statusEl.textContent = '로딩 실패';
          showError(e);
        }
      })();
    });
  </script>
</body>
</html>
